<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="utf-8"/>
    <title>JR鯖江駅（1番のりば）</title>
</head>
<body>
    <h5>バス停名：JR鯖江駅（1番のりば）</h5>

    <script type="text/javascript" src="jquery-2.1.0.min.js"></script>
    <script type="text/javascript">
    $( function(){
	    $.ajax({
		url:'http://tutujibus.com/timetableLookup.php?rosenid=1&callback=?',
		type:'GET',
		dataType:'jsonp',
		jsonp:'callback',
		success:function(data){
		    //alert("ok");
		    console.log(data);

		    $(function(){
			/*table variable*/
			var length = data.timetable.length;
			var table;
			var row_no=1;
			
			/*time variable*/
			var hour1;
			var minute1;
			var hour2;
			var minute2;
			var comp1;
			var comp2;
			var comp3=59;
			var res1=0;
			var res2=0;
			var res3=0;
			var res4=0;
			var DD = new Date();
			var flag1 = 0;
			var flag2 = 0;
			hour2 = DD.getHours();
			minute2 = DD.getMinutes();
			
			/*main function*/
			for(var i=0;i<length;i++){
			    var arraylistlength = data.timetable[i].list.length;
			    for(var j=0;j<arraylistlength;j++){
				if(data.timetable[i].list[j].busstopid == 1){
					/*indicate table*/
					table = document.getElementById("table1");
					var row = table.insertRow(-1);
					var cell = row.insertCell(-1);
					cell.appendChild(document.createTextNode(data.timetable[i].destination));
					cell = row.insertCell(-1);
					cell.appendChild(document.createTextNode(data.timetable[i].list[j].time));
					row_no++;
				}
			    }
			}
			/*debug code*/
			hour2 = 16;
			minute2 = 35;
			/*indicate next time*/
			for(i=0;i<length;i++){
			    arraylistlength=data.timetable[i].list.length;
			    for(j=0;j<arraylistlength;j++){
				if(data.timetable[i].list[j].busstopid==1){
				    hour1 = Number(data.timetable[i].list[j].time[0] + data.timetable[i].list[j].time[1]);
				    minute1 = Number(data.timetable[i].list[j].time[3] + data.timetable[i].list[j].time[4]);
					
				    comp1 = Math.abs(hour2 - hour1);
				    comp2 = Math.abs(minute2 - minute1);
				    console.log(comp2);
				    if(comp1 == 0){
					flag1 = 1;
					res1 = hour2;
					if(comp2<comp3 && minute1 > minute2){
					    comp3 = comp2;
					    res3 = minute1;
					}
				    }
				    else if(comp1 == 1){
					res2 = hour2;
					if(comp2<comp3 && minute1 > minute2){
					    comp3 = comp2;
					    res4 = minute1;
					}
				    }
				}
			    }
		    }
		    if(flag1 == 1){
			$("#message").html(res1+"時"+res3+"分");
		    }
		    else if(flag1 == 0){
			$("#message").html(res2+"時"+res4+"分");
		    }
		});

		},
		error:function(data){
		    alert("Access NG");
		}
	    });
	});

    
    
</script>

<div id="message"></div>

<table border="2">
<tr><th>行き先</th><th>発車時刻</th></tr>
<tbody id="table1"></tbody>
</table>

</body>
</html>
