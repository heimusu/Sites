# バスサジェストシステムver.1.4 仕様書
##概要
鯖江市立図書館への行き帰りにおいて，次のバス（つつじバス）が発車する時間と発車時刻までの残り時間，乗車したバスが図書館に到着する時刻を表示するシステムです．

##使い方
乗車するバス停を選ぶと，次のバスが発車する時刻と発車までの時間が表示される仕組みになっています．
図書館へ向かう場合には，図書館へ着く時刻も同じように表示します（図書館に向かわないバスの場合は，メッセージが表示されます）--
図書館から帰る場合も同様に，図書館発のバス停を選ぶと，次のバスについての情報が表示されます．

##コード仕様
jQueryを使って，APIからつつじバス中央線の時刻表およびバス停名を取得し，ハッシュを利用してバス停ごとにでデータを整理して表示させています．
乗車したバスが判明した後に当該バスの便番号を新たに取得し，その便がいつ図書館に到着するのかを表示する仕組みです．

###トップページと各バス停ごとの時刻表表示
busstopselect.htmlがトップページに相当し，乗車するバス停を選びます．
選ばれたバス停は固有ページとなり，先述の方法でデータを取得し，次のバスのサジェストを行います．
ここで，script部のコメントアウトmain function以下のfor文でバス停の時刻表を表示しています（行き先と発車時刻）．
timeTable.jsで現在時刻の取得と次に来るバスの到着時刻の取得，stopTime.jsでバスが来るまでの残り時間，busstopName.jsでバス停の名前の表示を行っています．

###次に発車するバスの発車時刻表示
timeTable.jsで該当バス停の時刻表を読み，次に来るバスの発車時刻を表示します．

APIの仕様上時刻データも文字列として配信されるので，文字列から数字に変換しています．その過程で，“時間”と“分”が別々に変数に格納されています(変数hour1,minute1)．それに合わせて，現在時刻も時間と分を別々に格納しています(変数hour2,minute2)．
これらは，オブジェクトinitで管理されています．

次のバスの発車時刻は，バス停の時刻表に対して現在時刻から差分演算を行って，最も近い時間を表示する仕組みになっています．その際にフラグを用いて次の時間を表すデータを管理しています．

###乗車したバスの図書館到着時間
次に乗車するバスがわかると同時に，現在乗車しているバスもわかります．
その発車時刻を利用して，現在乗車しているバスの便番号を新たに総当りで取得します．
取得できた便番号から，図書館に到着する時刻をまた総当りで取得します．
この際に，到着時間が取得できない（当該バスが図書館のバス停に停車しない）などの場合は，メッセージが表示される仕組みになっています．

###バスが発車するまでの残り時間表示
次に発車するバスの発車時刻がわかったら，その発車時刻までに残された時間を表示します(stopTime.js)．

こちらも差分演算で残り時間を計算していますが，次のバスが来るまで1時間以上ある場合とそうでない場合を区別するために，ここでもフラグを使って計算結果を管理しています．
計算が終了すると，それぞれのフラグ状況に応じて表示形態を選んで表示させます．

###神明駅について
神明駅についてはAPIによる行き先・発車時刻の配信結果が他の駅とは少し違うため，独自にファイルを作ることで対応しています．--
具体的には，行き先毎にハッシュを用いて取得データを変更しています．その他の仕様はstop.htmlと変わりません．

##今後について
図書館から帰る際のバスに，「どのバス停には何時に着くのか？」をサジェストする機能を追加する予定です．
また，図書館に到着後，「次のバスは何時に出るか」という内容のデータをサジェストさせようと考えています．
神明駅用ファイル(shinmei.html)に関しては手付かずですので，そちらのファイル分離等対応も進めていきます．

##さいごに
何か不具合等ありましたら，下記まで連絡をお願いいたします．
* 作成者：久保 陽一郎
* 連絡先：heimusu@gmail.com
